image: continuumio/miniconda3

options:
  docker: true

pipelines:
  default:
    - step:
        name: Install dependencies, unit test, and deploy a local node
        caches:
          - docker
          - pip

        script:
          - pip install docker-compose
          - conda env create -f config/environment.yml
          - source activate bathysphere_graph
          - docker pull neo4j:3.5
          - docker-compose up -d neo4j
          - sh src/healthcheck.sh
          - pytest
          - docker-compose down

    - step:
        name: Build docker image in docker
        caches:
          - docker
        script:
          - pip install docker-compose
          - docker-compose up -d --build
          - docker-compose down
